<div id="app">
  <section>
    <div class="max-w-screen-xl px-4 py-8 mx-auto sm:px-6 sm:py-12 lg:px-8">

      <ul class="grid gap-4 mt-8 sm:grid-cols-2 lg:grid-cols-4" v-if="products && load">
        <li v-for="item, index in products">
          <a :href="`/products/${item.url}`" class="block overflow-hidden group rounded-lg">
            <img :src="(item.images ? `/uploads/${item.images[0].name}_md.${item.images[0].ext}` : '/assets/img/noimage.png')" alt=""
              class="h-[150px] w-full object-cover transition duration-500 group-hover:scale-105 sm:h-[250px]" />
          </a>
          <div class="relative bg-white mt-3">
            <a :href="`/products/${item.url}`" class="block overflow-hidden group"></a>
            <h3 class="text-xs text-gray-700 group-hover:underline group-hover:underline-offset-4">
              {{item.name}}
            </h3>
            </a>

            <div class="flex justify-between mb-5 cursor-pointer">
              <span class="tracking-wider text-gray-900">{{ costFormat( item.amount ) }} {{ currency }}</span>

              <span @click="add(index)" v-if="!inCart(item.id) && !item.inCart || item.inCart === false">
                <svg class="h-4 w-4">
                  <use xlink:href="/assets/img/sprite.svg#cart" />
                </svg>
              </span>

              <span @click="remove(index)" v-else>
                <svg class="h-4 w-4 text-red-600">
                  <use xlink:href="/assets/img/sprite.svg#trash" />
                </svg>
              </span>

            </div>
        </li>
      </ul>
      <div v-else>products not found</div>
    </div>
  </section>
</div>

<script type="module">
  Vue.createApp({
    data() {
      return {
        load: false,
        currency: ref(),
        products: ref([]),
      };
    },

    mounted() {
      this.listProducts();
    },

    methods: {
      add(index) {
        const product = this.products[index]
        if (!this.inCart(product.id)) {
          this.products[index].inCart = true

          const image = product.images ? {
            name: product.images[0].name,
            ext: product.images[0].ext
          } : null;

          window.dispatchEvent(new CustomEvent("addProduct", {
            detail: {
              id: product.id,
              name: product.name,
              url: product.url,
              amount: product.amount,
              image: image,
            },
          }));
        }
      },

      remove(index) {
        const product = this.products[index]
        const cart = JSON.parse(localStorage.getItem('cart'))

        if (cart.find(x => x.id === product.id)) {
          product.inCart = false
          const indexCart = cart.findIndex(item => item.id === product.id)
          cart.splice(indexCart, 1);
          localStorage.setItem("cart", JSON.stringify(cart))
          window.dispatchEvent(new CustomEvent("delProduct"))
        }
      },

      async listProducts() {
        const response = await fetch(`/api/products`, {
          credentials: "include",
          method: 'GET',
        });
        this.resp = await response.json();
        if (this.resp.success) {
          if (localStorage.getItem('currency')) {
            this.currency = localStorage.getItem('currency');
          } else {
            localStorage.setItem('currency', this.resp.result.currency);
            this.currency = this.resp.result.currency;
          }
          this.products = this.resp.result.products;
          this.load = true;
        }
      },

      inCart(id) {
        if (localStorage.getItem('cart')) {
          const cart = JSON.parse(localStorage.getItem('cart'))
          let obj = cart.find(o => o.id === id);
          if (obj) {
            return true
          }
          return false
        }
      },

      costFormat(cost) {
        return (Number(cost) ? (Number(cost) / 100).toFixed(2) : "0.00");
      },
    },

  }).mount("#app");
</script>