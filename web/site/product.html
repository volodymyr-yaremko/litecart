<div id="product">
  <section>
    <div class="max-w-screen-xl px-4 py-8 mx-auto sm:px-6 sm:py-12 lg:px-8">
      <div class="grid grid-cols-1 gap-4 lg:grid-cols-3 lg:gap-8" v-if="load">
        <div class="relative h-[350px] sm:h-[450px]">
          <img :src="(product.images ? `/uploads/${product.images[0].name}_md.${product.images[0].ext}` : '/assets/img/noimage.png')" alt=""
            class="rounded-lg absolute inset-0 h-full w-full object-cover opacity-100 group-hover:opacity-0" />
          <img :src="(product.images ? `/uploads/${product.images[0].name}_md.${product.images[0].ext}` : '/assets/img/noimage.png')" alt=""
            class="rounded-lg absolute inset-0 h-full w-full object-cover opacity-0 group-hover:opacity-100" />
        </div>
        <div class="lg:col-span-2">
          <h1 class="text-xl font-bold text-gray-900 sm:text-3xl">{{product.name}}</h1>
          <p class="mt-4">{{product.description}}</p>
          <p class="mt-4">{{ costFormat( product.amount ) }} {{ currency }}</p>

          <form-button type="submit" name="Add" color="green" ico="row" class="mt-4" @click="add()" v-if="!product.inCart"></form-button>
          <form-button type="submit" name="Remove" color="red" ico="trash" class="mt-4" @click="remove()" v-else></form-button>
        </div>
      </div>
    </div>
  </section>
</div>

<script type="module">
  import FormButton from '/assets/js/form/button.js';

  Vue.createApp({
    components: {
      FormButton,
    },

    data() {
      return {
        load: false,
        currency: ref(),
        product: ref({}),
      };
    },

    mounted() {
      this.getProduct('{#.ProductUrl#}');
    },

    methods: {
      add() {
        if (!this.inCart(this.product.id)) {
          this.product.inCart = true

          const image = product.images ? {
            name: product.images[0].name,
            ext: product.images[0].ext
          } : null;

          window.dispatchEvent(new CustomEvent("addProduct", {
            detail: {
              id: this.product.id,
              name: this.product.name,
              url: this.product.url,
              amount: this.product.amount,
              image: image,
            },
          }));
        }
      },

      remove() {
        const cart = JSON.parse(localStorage.getItem('cart'))

        if (cart.find(x => x.id === this.product.id)) {
          this.product.inCart = false
          const indexCart = cart.findIndex(item => item.id === this.product.id);
          cart.splice(indexCart, 1);
          localStorage.setItem("cart", JSON.stringify(cart))
          window.dispatchEvent(new CustomEvent("delProduct"))
        }
      },

      async getProduct(url) {
        const response = await fetch(`/api/products/${url}`, {
          credentials: "include",
          method: 'GET',
        });
        this.resp = await response.json();
        if (this.resp.success) {
          if (localStorage.getItem('currency')) {
            this.currency = localStorage.getItem('currency');
          } else {
            localStorage.setItem('currency', this.resp.result.currency);
            this.currency = this.resp.result.currency;
          }
          this.product = this.resp.result;
          this.product.inCart = this.inCart(this.product.id);
          this.load = true;
        }
      },

      inCart(id) {
        if (localStorage.getItem('cart')) {
          const cart = JSON.parse(localStorage.getItem('cart'))
          let obj = cart.find(o => o.id === id);
          if (obj) {
            return true
          }
          return false
        }
      },

      costFormat(cost) {
        return (Number(cost) ? (Number(cost) / 100).toFixed(2) : "0.00");
      },
    },
  }).mount("#product");
</script>